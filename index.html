<!DOCTYPE html>
<html lang="it" data-app="CSVXPRESSTRANS" data-ver="0.1.0">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CSVXpressTrans</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json"/>
  <meta name="theme-color" content="#ffffff"/>

  <!-- Styles (riusa i CSS del repo CSVXpressSmart) -->
  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="style.mobile.cards.rev.v3.css"/>

  <style>
    .col-hidden{display:none !important}
    .report-preview{
      white-space:pre-wrap;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    .sr-only{
      position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;
      clip:rect(0,0,0,0);white-space:nowrap;border:0
    }
    /* ---- Modal Trasporti (in-page, zero dipendenze) ---- */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:18px; z-index:9999;}
    .modal{background:#0b0f14; color:#e9eef6; border-radius:16px; max-width:920px; width:100%; box-shadow:0 18px 60px rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.08);}
    .modal header{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.08)}
    .modal header h3{margin:0; font-size:16px}
    .modal .body{padding:14px 16px}
    .modal .grid{display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:10px}
    .modal label{display:flex; flex-direction:column; gap:6px; font-size:13px}
    .modal select,.modal input{padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#111824; color:#e9eef6; outline:none}
    .modal .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px}
    .modal .btn{border:0; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer}
    .modal .btn.primary{background:#b28cff; color:#0b0f14}
    .modal .btn.ghost{background:transparent; color:#e9eef6; border:1px solid rgba(255,255,255,.14)}
    .modal .hint{font-size:12px; opacity:.8}
    .modal .out{margin-top:10px; padding:10px 12px; border-radius:12px; background:rgba(255,255,255,.06); border:1px dashed rgba(255,255,255,.18)}
    .modal .out b{font-size:18px}
    @media (max-width:880px){
      .modal .grid{grid-template-columns:1fr}
    }
  </style>

  <!-- Google Analytics 4 (riusa ID CSVXpressSmart: cambia se vuoi) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-QZ7CQDJX3E"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-QZ7CQDJX3E', { anonymize_ip: true });
  </script>

  <!-- Microsoft Clarity (riusa ID CSVXpressSmart: cambia se vuoi) -->
  <script type="text/javascript">
    (function(c,l,a,r,i,t,y){
      c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
      t=l.createElement(r); t.async=1; t.src="https://www.clarity.ms/tag/"+i;
      y=l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "uy8owdlf8z");
  </script>

  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <meta name="format-detection" content="telephone=no"/>
  <link rel="apple-touch-icon" href="icon-192.png"/>
</head>

<body>
<header data-zone="header">
  <div class="logo-container">
    <img class="logo" src="icon-192.png" alt="CSVXpressTrans Logo"/>
    <h1>CSVXpressTrans</h1>
  </div>
</header>

<main>
  <p class="sr-only" id="deviceHint">Su smartphone ogni riga è visualizzata come scheda verticale.</p>

  <section data-zone="upload_csv" id="upload-section">
    <h2>Carica Listino CSV</h2>
    <input id="csvFileInput" type="file" accept=".csv" aria-label="Seleziona file CSV"/>
    <p id="csvError" style="color:red; display:none;">Errore nel caricamento del file CSV.</p>

    <div class="csv-memory" id="csv-memory" style="margin-top:12px;">
      <h3 style="margin:0 0 6px 0;">Memoria CSV</h3>
      <label class="chk" style="display:block; margin:6px 0;">
        <input id="toggleRememberCSV" type="checkbox" checked/>
        Ricorda l’ultimo CSV (non dovrai ricaricarlo ad ogni apertura)
      </label>
      <div class="csv-memory-actions" style="display:flex; gap:8px; flex-wrap:wrap; margin:8px 0;">
        <button id="btnLoadSavedCSV" type="button">Carica CSV salvato</button>
        <button id="btnClearSavedCSV" type="button">Cancella CSV salvato</button>
      </div>
      <div class="muted" id="savedCsvInfo" style="opacity:.8; font-size:13px;">Nessun CSV salvato.</div>
    </div>
  </section>

  <section data-zone="selezione_listino" id="listino-section">
    <h2>Filtra e Seleziona Articolo dal Listino</h2>
    <label for="searchListino">Cerca: </label>
    <input id="searchListino" type="text" placeholder="Inserisci codice o descrizione"/>
    <select id="listinoSelect"></select>
    <button id="btnAddFromListino" type="button">Aggiungi Articolo</button>
  </section>

  <section data-zone="tabella_articoli" id="articoli-section">
    <h2>Articoli Aggiunti</h2>

    <div class="smart-controls" id="smart-controls">
      <h3>Modalità Preventivo / Ordine (Smart)</h3>
      <label class="chk"><input id="toggleShowVAT" type="checkbox"/> Mostra IVA</label>
      <div class="vat-row">
        <label for="vatRate">IVA %</label>
        <input id="vatRate" type="text" inputmode="decimal" value="22" autocomplete="off" spellcheck="false"/>
      </div>
      <div class="smart-info" style="margin-top:8px;">
        <span class="hint">Trasporto: puoi lasciare quello del CSV oppure calcolarlo in modo più preciso con “Calcola Trasporto”.</span>
      </div>
    </div>

    <table id="articoli-table" border="1">
      <thead>
        <tr>
          <th>Codice</th>
          <th>Descrizione</th>
          <th>P. Lordo</th>
          <th>Sc.1%</th>
          <th>Sc.2%</th>
          <th>Marg.%</th>
          <th>Totale</th>
          <th>Trasp.</th>
          <th>Inst.</th>
          <th>Qtà</th>
          <th>Tot.</th>
          <th>Az.</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section data-zone="report_export" id="report-section">
    <h2>Report Articoli</h2>
    <div class="report-actions">
      <button id="btnWA" type="button">Invia WhatsApp</button>
      <button id="btnTXT" type="button">Genera TXT</button>
    </div>
    <div id="reportPreview" class="report-preview" style="margin-top:14px; display:none;"></div>
  </section>
</main>

<!-- Modal Trasporti -->
<div class="modal-backdrop" id="trModal">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="trTitle">
    <header>
      <h3 id="trTitle">Calcolo Trasporto (Use Friendly)</h3>
      <button class="btn ghost" type="button" id="trClose">Chiudi</button>
    </header>
    <div class="body">
      <div class="grid">
        <label>
          <span>Servizio</span>
          <select id="trService">
            <option value="PALLET">Bancale</option>
            <option value="GROUPAGE">Groupage / Parziale</option>
          </select>
          <span class="hint">Bancale: usa tariffe per Regione • Groupage: per Provincia con LM/q.li/bancali.</span>
        </label>

        <label>
          <span>Regione</span>
          <select id="trRegion"></select>
        </label>

        <label id="trProvinceWrap">
          <span>Provincia</span>
          <select id="trProvince"></select>
        </label>

        <label>
          <span>Cerca articolo (dataset trasporti)</span>
          <input id="trQ" type="search" placeholder="Es. MEC 820VDL / Cormach / CASCOS..." autocomplete="off"/>
        </label>

        <label>
          <span>Articolo</span>
          <select id="trArticle"></select>
          <span class="hint">Se trovi l’articolo, auto-imposta taglia bancale / peso / dimensioni.</span>
        </label>

        <label>
          <span>Quantità</span>
          <input id="trQty" type="number" min="1" step="1" value="1" inputmode="numeric"/>
        </label>

        <label id="trPalletTypeWrap">
          <span>Taglia bancale</span>
          <select id="trPalletType"></select>
        </label>

        <label id="trLmWrap" style="display:none;">
          <span>Metri lineari (LM)</span>
          <input id="trLm" type="text" inputmode="decimal" placeholder="es. 2,6"/>
        </label>

        <label id="trQuintaliWrap" style="display:none;">
          <span>Quintali</span>
          <input id="trQuintali" type="text" inputmode="decimal" placeholder="es. 18"/>
        </label>
      </div>

      <div class="row" style="margin-top:14px;">
        <label style="display:flex; gap:8px; align-items:center;">
          <input id="trInsurance" type="checkbox" checked/>
          Assicurazione (3%)
        </label>
        <button class="btn primary" type="button" id="trCalc">Calcola</button>
        <button class="btn ghost" type="button" id="trApply">Applica al Trasporto riga</button>
        <span class="hint" id="trTargetHint">Nessuna riga selezionata.</span>
      </div>

      <div class="out" id="trOut" style="display:none;">
        Costo preventivato: <b id="trOutCost">—</b>
        <div class="hint" id="trOutText" style="margin-top:6px;">—</div>
      </div>
    </div>
  </div>
</div>

<!-- Librerie necessarie -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<!-- App -->
<script defer src="app.js"></script>
</body>
</html>
