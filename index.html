<!DOCTYPE html>
<html lang="it" data-app="CSVXPRESSTRANS" data-ver="1.0.0">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>CSVXPRESSTRANS</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json"/>
  <meta name="theme-color" content="#0b0f14"/>

  <!-- Styles (CSVXpressSmart) -->
  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="style.mobile.cards.rev.v3.css"/>

  <!-- Apple / iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <meta name="format-detection" content="telephone=no"/>
  <link rel="apple-touch-icon" href="icons/icon-192.png"/>

  <!-- (facoltativo) micro-fix: evita che modali/overlay blocchino tutto -->
  <style>
    .sr-only{
      position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;
      clip:rect(0,0,0,0);white-space:nowrap;border:0
    }
    .tool-row{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin:10px 0 14px 0;
    }
    .btn-trasporti{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:12px;
      font-weight:700; text-decoration:none;
      background:#b28cff; color:#111;
    }
    .hint{
      opacity:.75; font-size:13px;
    }
  </style>

  <!-- PapaParse (CSV) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

  <!-- App -->
  <script defer src="app.js"></script>
</head>

<body>
<header data-zone="header">
  <div class="logo-container">
    <img class="logo" src="icons/icon-192.png" alt="CSVXPRESSTRANS Logo"/>
    <h1>CSVXPRESSTRANS</h1>
  </div>
</header>

<main>
  <p class="sr-only" id="deviceHint">
    Su smartphone ogni riga √® visualizzata come scheda verticale.
  </p>

  <!-- UPLOAD CSV -->
  <section data-zone="upload_csv" id="upload-section">
    <h2>Carica Listino CSV</h2>
    <input id="csvFileInput" type="file" accept=".csv" aria-label="Seleziona file CSV"/>
    <p id="csvError" style="color:red; display:none;">Errore nel caricamento del file CSV.</p>

    <!-- Memoria CSV (se gestita da app.js) -->
    <div class="csv-memory" id="csv-memory" style="margin-top:12px;">
      <h3 style="margin:0 0 6px 0;">Memoria CSV</h3>
      <label class="chk" style="display:block; margin:6px 0;">
        <input id="toggleRememberCSV" type="checkbox" checked/>
        Ricorda l‚Äôultimo CSV (non dovrai ricaricarlo ad ogni apertura)
      </label>
      <div class="csv-memory-actions" style="display:flex; gap:8px; flex-wrap:wrap; margin:8px 0;">
        <button id="btnLoadSavedCSV" type="button">Carica CSV salvato</button>
        <button id="btnClearSavedCSV" type="button">Cancella CSV salvato</button>
      </div>
      <div class="muted" id="savedCsvInfo" style="opacity:.8; font-size:13px;">
        Nessun CSV salvato.
      </div>
    </div>
  </section>

  <!-- SELEZIONE LISTINO -->
  <section data-zone="selezione_listino" id="listino-section">
    <h2>Filtra e Seleziona Articolo dal Listino</h2>
    <label for="searchListino">Cerca: </label>
    <input id="searchListino" type="text" placeholder="Inserisci codice o descrizione"/>
    <select id="listinoSelect"></select>
    <button id="btnAddFromListino" type="button">Aggiungi Articolo</button>
  </section>

  <!-- ARTICOLI -->
  <section data-zone="tabella_articoli" id="articoli-section">
    <h2>Articoli Aggiunti</h2>

    <!-- Link PWA Trasporti -->
    <div class="tool-row">
      <a class="btn-trasporti" href="./trasporti/" target="_blank" rel="noopener">
        üöö Trasporti Use Friendly
      </a>
      <span class="hint">
        Si apre in nuova scheda. Il pulsante ‚ÄúCalcola‚Äù nella colonna Trasporto aprir√† questa PWA.
      </span>
    </div>

    <!-- Controlli Smart (se usati da app.js) -->
    <div class="smart-controls" id="smart-controls">
      <h3>Modalit√† Preventivo / Ordine (Smart)</h3>

      <label class="chk"><input id="toggleShowVAT" type="checkbox"/> Mostra IVA</label>

      <div class="vat-row">
        <label for="vatRate">IVA %</label>
        <input id="vatRate" type="text" inputmode="decimal" value="22" autocomplete="off" spellcheck="false"/>
      </div>
    </div>

    <table id="articoli-table" border="1">
      <thead>
        <tr>
          <th data-col="codice">Codice</th>
          <th data-col="descrizione">Descrizione</th>
          <th data-col="prezzo">P. Lordo</th>
          <th data-col="sconto" title="Sconto 1%">Sc.1%</th>
          <th data-col="sconto2" title="Sconto 2%">Sc.2%</th>
          <th data-col="scontoCliente" title="Sconto cliente %">Sc.Cliente%</th>
          <th data-col="margine" title="Margine %">Marg.%</th>
          <th data-col="totaleNetto" title="Totale">Totale</th>
          <th data-col="trasporto" title="Trasporto">Trasp.</th>
          <th data-col="installazione" title="Installazione">Inst.</th>
          <th data-col="qta" title="Quantit√†">Qt√†</th>
          <th data-col="granTot" title="Gran Totale">Tot.</th>
          <th data-col="venduto" title="Venduto A ‚Ç¨">Vend.‚Ç¨</th>
          <th data-col="diff" title="Differenza sconto">Diff.</th>
          <th data-col="azioni" title="Azioni">Az.</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- REPORT -->
  <section data-zone="report_export" id="report-section">
    <h2>Report Articoli</h2>
    <div class="report-actions">
      <button id="btnWA" type="button">Invia WhatsApp</button>
      <button id="btnTXT" type="button">Genera TXT</button>
    </div>
    <div id="reportPreview" class="report-preview" style="margin-top:14px; display:none;"></div>
  </section>
</main>

<!-- Intercetta il ‚ÄúCalcola‚Äù trasporto e apri la PWA Trasporti -->
<script>
  (function(){
    const TR_URL = './trasporti/';

    document.addEventListener('click', function(e){
      // se il tuo app.js mette data-action="calc_tr" sul bottone ‚ÄúCalcola‚Äù
      const btn = e.target && e.target.closest && e.target.closest('button[data-action="calc_tr"]');
      if(btn){
        e.preventDefault();
        window.open(TR_URL, '_blank', 'noopener');
        return;
      }
      // fallback: se hai un bottone con testo "Calcola" dentro la cella trasporto
      const maybe = e.target && e.target.closest && e.target.closest('button');
      if(maybe && (maybe.textContent || '').trim().toLowerCase() === 'calcola'){
        // evita falsi positivi: apri solo se il bottone sta dentro la tabella articoli
        const inTable = maybe.closest('#articoli-table');
        if(inTable){
          e.preventDefault();
          window.open(TR_URL, '_blank', 'noopener');
        }
      }
    });
  })();
</script>

</body>
</html>
